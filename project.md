 # WorkflowMax to Dropbox Team Folder Integration

## 1. Overview

This Node.js application automates the creation of project folders in Dropbox Business team spaces based on new jobs created in WorkflowMax (WFM). It polls the WorkflowMax API for recently created jobs and, according to predefined rules based on the job number, creates a corresponding folder structure within a designated Dropbox team folder.

The integration uses OAuth 2.0 for authenticating with WorkflowMax and leverages the Dropbox API with team namespace access and user impersonation to manage folders within the team space.

## 2. Features

*   **WorkflowMax Integration**: Connects to WorkflowMax using OAuth 2.0.
*   **Automated Polling**: Regularly polls the WorkflowMax API (every minute) to fetch new jobs created since the last check.
*   **Dropbox Team Folder Creation**:
    *   Identifies a target Dropbox team subfolder based on the first digit of the WorkflowMax job number.
    *   Creates a new folder for the job within the determined subfolder (e.g., `Testing_J000123 - New Client Project`).
*   **Dropbox API v2**: Uses the official Dropbox API for robust and secure interaction.
*   **Team Namespace & User Context**: Correctly operates within a Dropbox Business team environment by using team namespaces and selecting a specific team member\'s context for API calls that require it.
*   **Environment Configuration**: Uses a `.env` file for managing sensitive credentials and settings.
*   **Scheduled Operations**: Uses `node-schedule` to run the polling task.
*   **Logging**: Provides console logging for monitoring and troubleshooting.

## 3. Prerequisites

*   Node.js (v14.x or later recommended)
*   npm (comes with Node.js) or yarn
*   A Dropbox Business account with:
    *   Team Folders enabled.
    *   A designated team member account (e.g., `mings@isagroups.com.au`) that has access to the target team folders.
*   A WorkflowMax account with API access.

## 4. Setup

### 4.1. Application Setup

1.  **Clone the repository** (if applicable) or ensure all project files (`index.js`, `package.json`) are in your project directory.
2.  **Install dependencies**:
    ```bash
    npm install express body-parser axios fs/promises dotenv node-schedule
    ```
    Or if you are using yarn:
    ```bash
    yarn add express body-parser axios fs/promises dotenv node-schedule
    ```
3.  **Create Environment File**:
    Create a `.env` file in the root of your project directory.

### 4.2. Dropbox App Configuration

1.  Go to the [Dropbox App Console](https://www.dropbox.com/developers/apps).
2.  Click **Create app**.
3.  Choose an API: **Scoped access**.
4.  Choose the type of access needed: **Full Dropbox** (if your team folders are standard team folders accessible via namespace) or **App Folder** (less likely for this use case, but depends on your specific Dropbox setup). For team folder access as implemented, "Full Dropbox" is generally required to allow the app to see and operate within team namespaces.
5.  Name your app (e.g., "WFM-Dropbox-Integration").
6.  **Permissions Tab**: Grant the following scopes. These are crucial for team folder operations and user context:
    *   `account_info.read`
    *   `files.content.read`
    *   `files.content.write`
    *   `sharing.read` (Used for some folder discovery, might be optional depending on the final discovery logic used)
    *   `team_data.member` (To list team members for `Dropbox-API-Select-User`)
    *   `team_data.team_space` (To access team space/namespaces)
    *   `team_info.read` (To get team information)
7.  **Settings Tab**:
    *   Note your **App key** (Client ID) and **App secret** (Client Secret).
    *   **Redirect URIs**: Add the URI for the OAuth callback. For local development, this will typically be `http://localhost:3000/oauth/callback` (adjust port if necessary). If using a tunneling service like ngrok for WorkflowMax to reach your local machine, use the ngrok URL.
8.  Generate an **Access Token**: In the OAuth 2 section of your app\'s settings page in the Dropbox App Console, click the "Generate" button under "Generated access token". This token will be used for `DROPBOX_TOKEN`. **This token must be generated by an admin user who has access to the team information and the ability to act on behalf of other users if your app is configured with "Team member file access" permissions.**

### 4.3. WorkflowMax API Configuration

1.  Ensure API access is enabled for your WorkflowMax account.
2.  You will need your WorkflowMax **Client ID** and **Client Secret** from your API settings in WorkflowMax.
3.  Your WorkflowMax Account ID (often referred to as Organisation ID).

### 4.4. Populate `.env` File

Add the following credentials and settings to your `.env` file:

```env
# WorkflowMax Credentials
WFX_CLIENT_ID=YOUR_WORKFLOWMAX_CLIENT_ID
WFX_CLIENT_SECRET=YOUR_WORKFLOWMAX_CLIENT_SECRET
WFX_ACCOUNT_ID=YOUR_WORKFLOWMAX_ACCOUNT_ID

# Dropbox Credentials & Settings
DROPBOX_TOKEN=YOUR_GENERATED_DROPBOX_OAUTH_TOKEN
# DROPBOX_ROOT specifies the top-level folder within your team space where project subfolders reside.
# Example: /Team Folder Name/Path/To/Projects
# Based on the script, this is likely "Innovative Surveying Public" located at the root of the selected namespace.
# The script dynamically finds this folder, so this variable might be illustrative of the target.
DROPBOX_ROOT="/Innovative Surveying Public" # Adjust if your main project container folder has a different name or path within the namespace

# Application Settings
PORT=3000 # Optional, defaults to 3000
DEBUG=true # Optional, set to true for more detailed logs
VERBOSE=true # Optional, set to true for even more verbose logs

# Specific Team Member Email for Dropbox Operations
# This user's context will be used for certain Dropbox API calls.
# Ensure this user has access to the target team folders.
DROPBOX_API_SELECT_USER_EMAIL=mings@isagroups.com.au
```

## 5. Running the Application

1.  **Start the server**:
    ```bash
    node index.js
    ```
2.  **Initial WorkflowMax Authentication**:
    *   Open your web browser and navigate to `http://localhost:PORT/oauth/login` (e.g., `http://localhost:3000/oauth/login`).
    *   You will be redirected to WorkflowMax to authorize the application.
    *   Upon successful authorization, you will be redirected back to the application, and `wfx_tokens.json` will be created/updated in your project directory to store the OAuth tokens.
3.  **Automatic Operation**:
    *   Once authenticated with WorkflowMax, the application will start its scheduled job.
    *   Every minute, it will poll WorkflowMax for new jobs.
    *   If new jobs are found that match the criteria, corresponding folders will be created in the designated Dropbox team folders.

## 6. Folder Structure Logic

The application expects a specific folder structure within your Dropbox team\'s namespace.

1.  **Team Namespace**: The application will attempt to identify your team\'s primary namespace (often named "Assorted content" by default if not customized, or it uses the first one returned by the API). All operations are performed within this namespace.
2.  **Main Project Container Folder**: Within the team namespace, it looks for a folder named **"Innovative Surveying Public"** (as per `DROPBOX_ROOT` and current logic).
3.  **Target Subfolders**: Inside "Innovative Surveying Public", it expects the following subfolders:
    *   `ISA PROJECT JOBS (2-5)`
    *   `ISA SURVEY PTY LTD (7-8)`
    *   `ISA SURVEYORS PTY LTD (6 or 9)`
4.  **Job Folder Creation**:
    *   The destination subfolder is chosen based on the *first digit* of the WorkflowMax Job ID:
        *   Job ID starts with 2, 3, 4, or 5 -> `ISA PROJECT JOBS (2-5)`
        *   Job ID starts with 7 or 8 -> `ISA SURVEY PTY LTD (7-8)`
        *   Job ID starts with 6 or 9 -> `ISA SURVEYORS PTY LTD (6 or 9)`
    *   New job folders are created with the name format: `Testing_JOBID - Job Name` (e.g., `Testing_J000456 - Site Survey Phase 1`).
    *   The "Testing\_" prefix is currently hardcoded.

## 7. Key Files

*   `index.js`: The main application script containing all the logic.
*   `.env`: Stores environment variables (credentials, configuration). **This file should be added to `.gitignore` and never committed to version control.**
*   `wfx_tokens.json`: Stores the WorkflowMax OAuth tokens (access token, refresh token, expiry). **This file should be added to `.gitignore` and never committed to version control.**
*   `package.json`: Defines project dependencies and scripts.
*   `project.md`: This file - project documentation.

## 8. Logging and Troubleshooting

*   The application logs its operations to the console.
*   For more detailed output, set `DEBUG=true` and `VERBOSE=true` in your `.env` file.
*   **Common Issues**:
    *   **Dropbox Token Permissions**: Ensure the `DROPBOX_TOKEN` was generated with all the required scopes listed in section 4.2.
    *   **Namespace/Team Folder Access**: The Dropbox user whose email is specified in `DROPBOX_API_SELECT_USER_EMAIL` (and whose context is used for `Dropbox-API-Select-User` header) must have explicit access to the "Innovative Surveying Public" team folder and its subfolders.
    *   **Incorrect Namespace ID**: If `getTeamNamespaceId()` selects the wrong namespace, team folder operations will fail or target the wrong space. The current logic selects the one named "Assorted content" or the first one from the list if that's not found.
    *   **WorkflowMax API Errors**: Check logs for errors from the WorkflowMax API (e.g., invalid credentials, rate limiting).
    *   **Redirect URI Mismatch**: Ensure the redirect URI in your `.env` (if applicable, though the callback is hardcoded for ngrok in one place and dynamically generated in another for WFM token exchange) matches exactly what is configured in both your Dropbox App and WorkflowMax API client settings. The WFM callback URL is currently hardcoded for a specific ngrok URL in the `/oauth/login` route and dynamically constructed for the `/oauth/callback` token exchange. For production, these should be consistent and use your actual deployment URL.

This project provides a robust way to link your WorkflowMax job creation process with your Dropbox Business organizational structure, ensuring project assets are consistently managed.
